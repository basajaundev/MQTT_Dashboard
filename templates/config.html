{% extends "layout.html" %}

{% block title %}
    Configuracion - MQTT IoT
{% endblock %}

{% block content %}
<div class="config-container">
    <nav class="config-tabs">
        <a href="#" class="tab-link active" data-tab="servers">üóÑÔ∏è Servidores</a>
        <a href="#" class="tab-link" data-tab="settings">‚öôÔ∏è Ajustes del Sistema</a>
    </nav>

    <!-- Pestana de Servidores -->
    <div id="servers" class="tab-content active">
        <div class="server-management-header">
            <h2>Gestion de Servidores MQTT</h2>
            <button id="addServerBtn" class="btn-icon" data-action="add-server-modal" title="Anadir Servidor">üÜï</button>
        </div>
        <div class="servers-list-grid" id="serversListGrid">
            <!-- Las tarjetas de servidor se insertaran aqui dinamicamente -->
        </div>
    </div>

    <!-- Pestana de Ajustes Unificada -->
    <div id="settings" class="tab-content">

        <div class="settings-layout">
            <!-- Seccion Ajustes del Dashboard Fusionada -->
            <section class="settings-section">
                <h3>Ajustes del Dashboard</h3>
                <p class="section-desc">Configura el comportamiento y preferencias del dashboard.</p>

                <div class="triple-fused-content">
                    <!-- General (tercio izquierdo) -->
                    <div class="fused-third general-third">
                        <h4>General</h4>
                        <div class="input-group">
                            <label for="refreshInterval">Intervalo de Auto-Refresco (s)</label>
                            <input type="number" id="refreshInterval" value="30" min="5" aria-label="Intervalo de auto-refresco en segundos">
                        </div>
                        <div class="input-group">
                            <label for="maxMissedPings">Tolerancia de Pings (Vidas)</label>
                            <input type="number" id="maxMissedPings" value="2" min="1" max="10" aria-label="Numero de pings perdidos antes de marcar como offline">
                        </div>
                        <button class="btn-primary" data-action="save-settings" style="width: 100%;">Guardar Ajustes</button>
                    </div>

                    <!-- Seguridad (tercio central) -->
                    <div class="fused-third security-third">
                        <h4>Seguridad</h4>
                        <div class="input-group">
                            <label for="newPassword">Nueva Contrasena</label>
                            <input type="password" id="newPassword" aria-label="Nueva contrasena de administrador">
                        </div>
                        <div class="input-group">
                            <label for="confirmPassword">Confirmar Contrasena</label>
                            <input type="password" id="confirmPassword" aria-label="Confirmar nueva contrasena">
                        </div>
                        <button class="btn-primary" data-action="change-password" style="width: 100%;">Cambiar Contrasena</button>
                    </div>

                    <!-- Notificaciones (tercio derecho) -->
                    <div class="fused-third notifications-third">
                        <h4>Toast</h4>

                        <!-- Configuracion de Toast -->
                        <div class="toast-config-inline">
                            <div class="toast-config-row">
                                <label for="toastEnabled">Habilitar Toast</label>
                                <label class="theme-switch compact-switch">
                                    <input type="checkbox" id="toastEnabled" checked aria-label="Habilitar notificaciones toast">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="toast-config-row">
                                <label for="toastDuration">Duracion</label>
                                <input type="number" id="toastDuration" min="1" max="30" value="5" class="compact-number-input" aria-label="Duracion del toast en segundos">
                                <span class="unit-label">seg.</span>
                            </div>
                            <div class="toast-config-row">
                                <label for="toastAnimation">Animacion</label>
                                <select id="toastAnimation" class="compact-select" aria-label="Tipo de animacion del toast">
                                    <option value="fade">Fade</option>
                                    <option value="slide">Slide</option>
                                    <option value="zoom">Zoom</option>
                                </select>
                            </div>
                            <div class="toast-config-row">
                                <label for="toastPosition">Posicion</label>
                                <select id="toastPosition" class="compact-select" aria-label="Posicion del toast">
                                    <option value="top-right">Sup. Der.</option>
                                    <option value="top-left">Sup. Izq.</option>
                                    <option value="bottom-right">Inf. Der.</option>
                                    <option value="bottom-left">Inf. Izq.</option>
                                </select>
                            </div>
                            <div class="toast-config-row">
                                <label for="toastTypes">Tipos</label>
                                <select id="toastTypes" class="compact-select" aria-label="Tipos de toast a mostrar">
                                    <option value="all">Todos</option>
                                    <option value="success">Solo exitos</option>
                                    <option value="error">Solo errores</option>
                                    <option value="warning">Solo advertencias</option>
                                    <option value="info">Solo informativos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Seccion Whitelist + Grupos Fusionados -->
            <section class="settings-section">
                <h3>Gestion de Dispositivos</h3>
                <p class="section-desc">Gestiona los dispositivos permitidos y organizalos en grupos.</p>

                <div class="fused-card-content">
                    <!-- Whitelist (mitad izquierda) -->
                    <div class="fused-half whitelist-half">
                        <h4>Whitelist</h4>
                        <div class="whitelist-form-inline">
                            <select id="whitelist-device-id" aria-label="Seleccionar dispositivo para agregar a whitelist">
                                <option value="">Dispositivo...</option>
                            </select>
                            <select id="whitelist-group-id" aria-label="Seleccionar grupo para el dispositivo">
                                <option value="">Grupo...</option>
                            </select>
                        </div>
                        <button class="btn-success" data-action="add-to-whitelist" style="width: 100%;">Anadir</button>
                        <div id="whitelistContainer" class="list-items whitelist-list"></div>
                    </div>

                    <!-- Grupos (mitad derecha) -->
                    <div class="fused-half groups-half">
                        <h4>Grupos</h4>
                        <div id="groupsList" class="list-items groups-list"></div>
                        <button class="btn-primary" data-action="add-group-modal" style="width: 100%;">
                            + Crear Grupo
                        </button>
                    </div>
                </div>
            </section>

            <!-- Seccion Backup -->
            <section class="settings-section settings-section-backup">
                <h3>Backup de Base de Datos</h3>
                <p class="section-desc">Copias de seguridad automaticas y restauracion.</p>

                <div class="backup-controls-row">
                    <div class="backup-control-item">
                        <label for="autoBackupEnabled">Backup Automatico</label>
                        <label class="theme-switch compact-switch">
                            <input type="checkbox" id="autoBackupEnabled" aria-label="Habilitar backup automatico">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="backup-control-item">
                        <label for="autoBackupInterval">Intervalo (Horas)</label>
                        <input type="number" id="autoBackupInterval" value="24" min="1" max="168" aria-label="Intervalo de backup automatico en horas">
                    </div>
                    <div class="backup-control-item">
                        <label for="autoBackupKeep">Backups a Mantener</label>
                        <input type="number" id="autoBackupKeep" value="7" min="1" max="30" aria-label="Numero de backups a mantener">
                    </div>
                </div>

                <div class="backups-list-container">
                    <h4>Backups Disponibles (<span id="backupsCount">0</span>)</h4>
                    <div id="backupsList" class="backups-list">
                        <div class="empty-state loading-state">Cargando backups...</div>
                    </div>
                </div>

                <div class="backup-actions-bottom">
                    <button class="btn-primary full-width-btn" data-action="manual-backup" aria-label="Crear backup ahora">
                        üíæ Backup Ahora
                    </button>
                </div>
            </section>

            <!-- Seccion MQTT -->
            <section class="settings-section settings-section-mqtt">
                <h3>Configuracion MQTT</h3>
                <p class="section-desc">Ajustes de conexion y comportamiento MQTT.</p>

                <div class="mqtt-config-row">
                    <div class="mqtt-control-item">
                        <label for="mqttKeepalive">Keepalive (segundos)</label>
                        <input type="number" id="mqttKeepalive" value="60" min="5" max="300" aria-label="Intervalo keepalive en segundos">
                    </div>
                    <div class="mqtt-control-item">
                        <label for="mqttReconnectDelay">Delay Reconexion (segundos)</label>
                        <input type="number" id="mqttReconnectDelay" value="5" min="1" max="60" aria-label="Delay antes de reconectar">
                    </div>
                    <div class="mqtt-control-item">
                        <label for="mqttDefaultQoS">QoS por Defecto</label>
                        <select id="mqttDefaultQoS" aria-label="QoS por defecto para mensajes">
                            <option value="0">0 - At most once</option>
                            <option value="1" selected>1 - At least once</option>
                            <option value="2">2 - Exactly once</option>
                        </select>
                    </div>
                </div>

                <div class="mqtt-options-row">
                    <label class="theme-switch compact-switch">
                        <input type="checkbox" id="mqttCleanSession" checked aria-label="Limpiar sesion al conectar">
                        <span class="slider"></span>
                    </label>
                    <span>Clean Session</span>
                </div>

                <div class="mqtt-actions-bottom">
                    <button class="btn-primary full-width-btn" data-action="save-mqtt-config">
                        Guardar Configuracion MQTT
                    </button>
                </div>
            </section>
        </div>

    </div>
</div>

<!-- Modal para anadir/editar servidor -->
<div id="serverModal" class="modal">
    <div class="modal-content">
        <span class="close" data-action="close-server-modal">&times;</span>
        <h2 id="serverModalTitle">Anadir Nuevo Servidor</h2>
        <div class="modal-form">
            <input type="hidden" id="serverId" value="">
            <div class="input-group">
                <label for="serverName">Nombre del Servidor *</label>
                <input type="text" id="serverName" placeholder="Ej: Mi Broker Local" required aria-label="Nombre identificativo del servidor">
            </div>
            <div class="input-group">
                <label for="serverBroker">Broker (IP o Dominio) *</label>
                <input type="text" id="serverBroker" placeholder="Ej: localhost o broker.hivemq.com" required aria-label="Direccion IP o nombre de dominio del broker MQTT">
            </div>
            <div class="input-group">
                <label for="serverPort">Puerto *</label>
                <input type="number" id="serverPort" value="1883" min="1" max="65535" required aria-label="Puerto del broker MQTT (1883 por defecto)">
            </div>
            <div class="input-group">
                <label for="serverUsername">Usuario (opcional)</label>
                <input type="text" id="serverUsername" placeholder="Usuario MQTT" aria-label="Nombre de usuario para autenticacion MQTT">
            </div>
            <div class="input-group">
                <label for="serverPassword">Contrasena (opcional)</label>
                <input type="password" id="serverPassword" placeholder="Contrasena MQTT" aria-label="Contrasena para autenticacion MQTT">
            </div>
            <button class="btn-primary" data-action="save-server">Guardar Servidor</button>
        </div>
    </div>
</div>

<!-- Modal para anadir/editar grupo -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <span class="close" data-action="close-group-modal">&times;</span>
        <h3 id="groupModalTitle">Crear Grupo</h3>
        <div class="modal-form">
            <input type="hidden" id="groupId" value="">
            <div class="form-group">
                <label for="groupName">Nombre del Grupo</label>
                <input type="text" id="groupName" placeholder="Ej: Sala de Estar, Cocina, Dormitorio" maxlength="50">
                <div id="groupNameError" class="form-error" style="display: none;"></div>
            </div>
            <div class="form-group">
                <label for="groupDescription">Descripcion (opcional)</label>
                <textarea id="groupDescription" placeholder="Descripcion breve del grupo..." rows="2" maxlength="200"></textarea>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" data-action="cancel-group-modal">Cancelar</button>
            <button class="btn-primary" data-action="save-group">Guardar Grupo</button>
        </div>
    </div>
</div>
{% endblock %}
